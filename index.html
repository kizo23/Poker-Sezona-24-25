<script>
    document.addEventListener("DOMContentLoaded", () => {
        const buyInCost = 5;
        const games = [ /* Your game data */ ];
        const playerStats = {};


        //Initializes the player stats object
        const initPlayerStats = () => {
            games.forEach(game => {
               [...game.players, ...game.rebuys].forEach(player => {
                 if(!playerStats[player]) {
                   playerStats[player] = { points: 0, games: 0, wins: 0, rebuys: 0, net: 0, earned: 0, spent: 0 };
                }
               });
            });
        };

        const createTableRow = (content, className = '') => {
            const row = document.createElement("tr");
            row.className = className;
            row.innerHTML = content;
            return row;
        };
          const createGameHistoryRowContent = (game, index, totalPot) => {
               return `
                    <td>${index + 1}</td>
                    <td><span class="first-place">${game.results[0]}</span>,
                        <span class="second-place">${game.results[1]}</span>,
                        <span class="third-place">${game.results[2]}</span></td>
                    <td>${game.players.join(", ")}</td>
                    <td>${game.rebuys.join(", ")}</td>
                    <td>${totalPot}€</td>
                `;
            };

            const createRankingTableRowContent = (rank, name, stats) => {
                  let color = "";
                 if (rank === 0) color = "yellow";
                 if (rank === 1) color = "orange";
                 if (rank === 2) color = "red";
                   return `
                    <td>${rank + 1}</td>
                     <td style="color: ${color}" onmouseover="showTooltip(event, '${name}')" onmouseleave="hideTooltip()">${name}</td>
                    <td>${stats.points}</td>
                    <td>${stats.games}</td>
                    <td>${(stats.points / stats.games).toFixed(2)}</td>
                    <td>${stats.wins}</td>
                    <td>${stats.rebuys}</td>
                    <td>${stats.net}€</td>
                `;
            };
        const calculateStats = () => {
            const gameHistory = document.getElementById("game-history");
            const payouts = [0.5, 0.3, 0.2];

            games.forEach((game, index) => {
                const totalPot = (game.players.length * buyInCost) + (game.rebuys.length * buyInCost);

                // Game History Table
                const rowContent = createGameHistoryRowContent(game, index, totalPot);
                gameHistory.appendChild(createTableRow(rowContent));

                // Update Player Stats
                 game.results.forEach((player, position) => {
                      if (!playerStats[player]) {
                            console.error(`Player ${player} found in results but not initialized.`);
                            return; // Skip if player is not initialized
                        }
                    const points = [3, 2, 1][position];
                    playerStats[player].points += points;
                    if (position < payouts.length) {
                        playerStats[player].earned += totalPot * payouts[position];
                        if (position === 0) {
                         playerStats[player].wins += 1;
                        }
                     }
                   });


                game.players.forEach(player => {
                     if (!playerStats[player]) {
                         console.error(`Player ${player} found in players but not initialized.`);
                          return;
                    }
                    playerStats[player].games += 1;
                    playerStats[player].spent += buyInCost;
                });

                 game.rebuys.forEach(player => {
                     if (!playerStats[player]) {
                           console.error(`Player ${player} found in rebuys but not initialized.`);
                           return;
                       }
                       playerStats[player].rebuys += 1;
                       playerStats[player].spent += buyInCost;
                 });
            });

            Object.values(playerStats).forEach(player => {
                player.net = player.earned - player.spent;
            });
        };

          const populateRankings = () => {
             const rankingsTable = document.querySelector("#rankings-table tbody");
            rankingsTable.innerHTML = ""; // Clear existing rows

            const sortedPlayers = Object.entries(playerStats).sort((a, b) => b[1].points - a[1].points);

             sortedPlayers.forEach(([name, stats], rank) => {
                  const rowContent = createRankingTableRowContent(rank, name, stats);
                   rankingsTable.appendChild(createTableRow(rowContent));
             });
        };
         const showTooltip = (event, player) => {
            const tooltip = document.getElementById("tooltip");
            const stats = playerStats[player];
            tooltip.innerHTML = `
                <strong>${player}'s Stats</strong><br>
                Points: ${stats.points}<br>
                Games: ${stats.games}<br>
                Wins: ${stats.wins}<br>
                Rebuys: ${stats.rebuys}<br>
                Net: ${stats.net}€<br>
                P/G: ${(stats.points / stats.games).toFixed(2)}
            `;
            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
            tooltip.style.display = "block";
        };

        const hideTooltip = () => {
            const tooltip = document.getElementById("tooltip");
            tooltip.style.display = "none";
        };
          initPlayerStats();
        calculateStats();
        populateRankings();
    });
</script>
